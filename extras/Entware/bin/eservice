#!/bin/sh
# /opt/bin/eservice
#
# This is a small helper script that makes
# executing Entware's init.d scripts easier
#
# Examples:
#  eservice dnsmasq restart - restart dnsmasq
#  eservice list - list all services and their statuses
#

SERVICE="$1"
ACTION="$2"
CALLER="$(basename "$0" .sh)"

if [ "$SERVICE" = "list" ] && [ -z "$ACTION" ]; then
    ANSI_GREEN=$(printf '\033[1;32m')
    ANSI_RED=$(printf '\033[1;31m')
    ANSI_YELLOW=$(printf '\033[1;33m')
    ANSI_WHITE=$(printf '\033[1;37m')
    ANSI_RESET=$(printf '\033[0m')

    for FILE in $(/opt/bin/find /opt/etc/init.d/ -perm '-u+x' -name 'S*' | sort); do
        FILE_BASE="$(basename "$FILE" | sed 's/^S[0-9]*//')"
        STATUS="$("$FILE" check 2>/dev/null)"

        if echo "$STATUS" | grep -q 'alive'; then
            STATUS="${ANSI_GREEN}alive${ANSI_RESET}"
        elif echo "$STATUS" | grep -q 'dead'; then
            STATUS="${ANSI_RED}dead${ANSI_RESET}"
        elif [ -n "$STATUS" ]; then
            STATUS="${ANSI_YELLOW}other${ANSI_RESET}"
        else
            STATUS="${ANSI_WHITE}unknown${ANSI_RESET}"
        fi

        printf "%-20s %-20s %-30s\n" "$FILE_BASE" "$STATUS" "$FILE"
    done
    exit
fi

[ -z "$SERVICE" ] && { echo "Service not specified"; exit 1; }
[ -z "$ACTION" ] && { echo "Action not specified"; exit 1; }

for FILE in $(/opt/bin/find /opt/etc/init.d/ -perm '-u+x' -name 'S*'); do
    FILE_CHECK="$(basename "$FILE")"
    MAX=4
    while [ "$MAX" -gt 0 ]; do
        FILE_CHECK="$(echo "$FILE_CHECK" | cut -c2-)"

        if [ "$FILE_CHECK" = "$SERVICE" ]; then
            case "$FILE" in
                S* | *.sh )
                    trap "" INT QUIT TSTP EXIT
                    #shellcheck disable=SC1090,SC2240
                    . "$FILE" "$ACTION" "$CALLER"
                ;;
                *)
                    "$FILE" "$ACTION" "$CALLER"
                ;;
            esac

            exit
        fi

        MAX=$((MAX-1))
    done
done

echo "Service \"$SERVICE\" not found"
